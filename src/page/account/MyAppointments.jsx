import React, { useState, useEffect } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import {
  faCalendarAlt, faClock, faUserMd, faPhone, faEnvelope, faStethoscope,
  faNotesMedical, faMoneyBillWave, faEye, faTrash, faFilter, faSearch,
  faSpinner, faExclamationTriangle, faCheckCircle, faTimesCircle, faHourglassHalf,
  faCalendarCheck, faRefresh, faCreditCard, faVideo, faStar, faFlaskVial
} from '@fortawesome/free-solid-svg-icons';
import axiosClient from '../../services/axiosClient';
import classNames from 'classnames/bind';
import styles from './MyAppointments.module.scss';

const cx = classNames.bind(styles);

const hashAppointmentId = (appointmentId) => {
  return btoa(appointmentId.toString()).replace(/=/g, "");
};

function MyAppointments() {
  const navigate = useNavigate();

  const [appointments, setAppointments] = useState([]);
  const [filteredAppointments, setFilteredAppointments] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [selectedAppointment, setSelectedAppointment] = useState(null);
  const [showModal, setShowModal] = useState(false);
  const [isCancelling, setIsCancelling] = useState(false); // Add loading state for cancel
  const [filters, setFilters] = useState({
    status: 'all',
    dateRange: 'all',
    searchTerm: ''
  });
  const [currentPage, setCurrentPage] = useState(1);

  const appointmentsPerPage = 6;
  const user = JSON.parse(localStorage.getItem('user') || '{}');
  const accessToken = localStorage.getItem('accessToken');

  // Helper function to check if appointment has feedback
  const checkFeedbackStatus = (appointment) => {
    // Check if appointment has feedback array and valid rating
    return !!appointment.feedback;
  };

  // Handle feedback navigation
  const handleFeedbackNavigation = (appointment) => {
    const appointmentId = appointment.appointment_id || appointment.id;
    const hasFeedback = checkFeedbackStatus(appointment);

    if (hasFeedback) {
      // ƒê√£ ƒë√°nh gi√° -> ƒëi trang ch·ªß feedback v·ªõi highlight
      navigate("/feedback", {
        state: { 
          highlightAppointment: appointmentId,
          message: "B·∫°n ƒë√£ ƒë√°nh gi√° bu·ªïi t∆∞ v·∫•n n√†y. Xem l·∫°i ƒë√°nh gi√° c·ªßa b·∫°n b√™n d∆∞·ªõi."
        }
      });
    } else {
      // Ch∆∞a ƒë√°nh gi√° -> ƒëi trang ƒë√°nh gi√°
      navigate(`/feedback/consultation/${appointmentId}`, {
        state: { appointmentData: appointment }
      });
    }
  };

  // C·∫≠p nh·∫≠t statusConfig ƒë·ªÉ th√™m status completed
  const statusConfig = {
    'pending': { label: 'Ch·ªù x√°c nh·∫≠n', icon: faHourglassHalf, bgColor: '#fff8e1', textColor: '#e65100' },
    'confirmed': { label: 'ƒê√£ x√°c nh·∫≠n', icon: faCheckCircle, bgColor: '#e8f5e8', textColor: '#2e7d32' },
    'success': { label: 'ƒê√£ ho√†n th√†nh thanh to√°n', icon: faCalendarCheck, bgColor: '#e3f2fd', textColor: '#1976d2' },
    'completed': { label: 'ƒê√£ ho√†n th√†nh t∆∞ v·∫•n', icon: faCheckCircle, bgColor: '#f3e5f5', textColor: '#7b1fa2' },
    'rejected': { label: 'ƒê√£ h·ªßy', icon: faTimesCircle, bgColor: '#ffebee', textColor: '#d32f2f' }
  };

  const getStatusInfo = (status) => statusConfig[status] || statusConfig['pending'];

  const fetchAppointments = async () => {
    try {
      setIsLoading(true);
      setError(null);

      const response = await axiosClient.get(`/v1/appointments/user/${user.user_id}`, {
        headers: { 'x-access-token': accessToken }
      });

      if (response.data?.success) {
        const userAppointments = response.data.data
          .filter(appointment => appointment.user_id === user.user_id)
          .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        setAppointments(userAppointments);
        setFilteredAppointments(userAppointments);
      } else {
        throw new Error('Invalid response format');
      }
    } catch (error) {
      console.error('‚ùå Error fetching appointments:', error);
      setError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch cu·ªôc h·∫πn. Vui l√≤ng th·ª≠ l·∫°i.');
    } finally {
      setIsLoading(false);
    }
  };

  const applyFilters = () => {
    let filtered = [...appointments];

    if (filters.status !== 'all') {
      filtered = filtered.filter(apt => apt.status === filters.status);
    }

    if (filters.dateRange !== 'all') {
      const today = new Date();
      const days = { week: 7, month: 30, quarter: 90 }[filters.dateRange];
      const filterDate = new Date(today.getTime() - days * 24 * 60 * 60 * 1000);
      filtered = filtered.filter(apt => new Date(apt.created_at) >= filterDate);
    }

    if (filters.searchTerm.trim()) {
      const searchTerm = filters.searchTerm.toLowerCase();
      filtered = filtered.filter(apt =>
        apt.fullName?.toLowerCase().includes(searchTerm) ||
        apt.doctor_name?.toLowerCase().includes(searchTerm) ||
        apt.consultant_type?.toLowerCase().includes(searchTerm) ||
        apt.symptoms?.toLowerCase().includes(searchTerm)
      );
    }

    setFilteredAppointments(filtered);
    setCurrentPage(1);
  };

  const handleFilterChange = (filterType, value) => {
    setFilters(prev => ({ ...prev, [filterType]: value }));
  };

  const handlePayment = (appointment) => {
    const appointmentId = appointment.id || appointment.appointment_id;

    if (!appointmentId || !appointment.price_apm || appointment.price_apm <= 0) {
      alert('Cu·ªôc h·∫πn n√†y kh√¥ng th·ªÉ thanh to√°n');
      return;
    }

    if (appointment.status === 'rejected') {
      alert('Kh√¥ng th·ªÉ thanh to√°n cho cu·ªôc h·∫πn ƒë√£ b·ªã h·ªßy');
      return;
    }

    if (!['confirmed', '1'].includes(appointment.status)) {
      alert('Ch·ªâ c√≥ th·ªÉ thanh to√°n cho c√°c cu·ªôc h·∫πn ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n');
      return;
    }

    navigate(`/paymentappointment/${appointmentId}`, {
      state: { appointmentData: appointment }
    });
  };

  const handleRebook = () => navigate('/services/appointment-consultation');

  const viewAppointmentDetails = (appointment) => {
    setSelectedAppointment(appointment);
    setShowModal(true);
  };

  const handleJoinMeeting = (appointment) => {
    const meetUrl = 'https://meet.google.com/ymf-dwbi-uhy';
    window.open(meetUrl, '_blank', 'noopener,noreferrer');
    console.log(`User joined meeting for appointment ${appointment.id}`);
  };

  // Utility functions
  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString('vi-VN', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });
  };

  const formatCurrency = (amount) => {
    const numericAmount = Math.floor(parseFloat(amount) || 0);
    return numericAmount.toLocaleString('vi-VN') + 'ƒë';
  };

  const indexOfLastAppointment = currentPage * appointmentsPerPage;
  const indexOfFirstAppointment = indexOfLastAppointment - appointmentsPerPage;
  const currentAppointments = filteredAppointments.slice(indexOfFirstAppointment, indexOfLastAppointment);
  const totalPages = Math.ceil(filteredAppointments.length / appointmentsPerPage);

  useEffect(() => {
    if (accessToken && user.user_id) fetchAppointments();
  }, [accessToken, user.user_id]);

  useEffect(() => {
    applyFilters();
  }, [filters, appointments]);

  const isConsultationDay = (appointmentDate) => {
    if (!appointmentDate) return false;
    
    const today = new Date();
    const consultationDate = new Date(appointmentDate);

    today.setHours(0, 0, 0, 0);
    consultationDate.setHours(0, 0, 0, 0);

    return today.getTime() === consultationDate.getTime();
  };

  // Add handleCancelPaidAppointment function for refund process
  const handleCancelPaidAppointment = async (appointment) => {
    const appointmentId = appointment.appointment_id || appointment.id;
    
    const confirmCancel = window.confirm(
      `‚ö†Ô∏è H·ª¶Y CU·ªòC H·∫∏N ‚ö†Ô∏è\n\n` +
      `Cu·ªôc h·∫πn: ${appointment.consultant_type}\n` +
      `Ng√†y: ${formatDate(appointment.appointment_date)}\n` +
      `Ph√≠ t∆∞ v·∫•n: ${formatCurrency(appointment.price_apm)}\n\n` +
      `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy v√† y√™u c·∫ßu ho√†n ti·ªÅn?`
    );
    
    if (!confirmCancel) return;

    try {
      setIsCancelling(true);

      // Step 1: Send email notification
      try {
        await axiosClient.post('/v1/emails/send-appointment-cancellation', {
          appointment_id: appointmentId,
          reason: 'Thay ƒë·ªïi l·ªãch tr√¨nh c√° nh√¢n'
        }, {
          headers: { 'x-access-token': accessToken }
        });
        console.log('‚úÖ Email sent successfully');
      } catch (emailError) {
        console.warn('‚ö†Ô∏è Email failed, continuing...', emailError);
      }

      // Step 2: Cancel appointment (existing API)
      const response = await axiosClient.post('/v1/users/cancel-appointment', {
        appointment_id: appointmentId
      }, {
        headers: { 'x-access-token': accessToken }
      });

      if (response.data?.success) {
        alert(
          `‚úÖ H·ª¶Y CU·ªòC H·∫∏N TH√ÄNH C√îNG!\n\n` +
          `üìß Email th√¥ng b√°o ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn: ${user.email}\n` +
          `üí∞ Ho√†n ti·ªÅn s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω trong 3-5 ng√†y l√†m vi·ªác\n\n` +
          `Vui l√≤ng ki·ªÉm tra email ƒë·ªÉ theo d√µi.`
        );
        
        // Update status
        setAppointments(prevAppointments => 
          prevAppointments.map(apt => 
            (apt.appointment_id === appointmentId || apt.id === appointmentId)
              ? { ...apt, status: 'rejected' }
              : apt
          )
        );
        
        await fetchAppointments();
        
      } else {
        throw new Error(response.data?.message || 'Kh√¥ng th·ªÉ h·ªßy cu·ªôc h·∫πn');
      }
    } catch (error) {
      console.error('‚ùå Error:', error);
      alert(
        error.response?.data?.message || 
        'C√≥ l·ªói x·∫£y ra. Vui l√≤ng li√™n h·ªá h·ªó tr·ª£.'
      );
    } finally {
      setIsCancelling(false);
    }
  };

  // Add handleCancel function
  const handleCancel = async (appointment) => {
    const appointmentId = appointment.appointment_id || appointment.id;
    
    // Confirmation dialog
    const confirmCancel = window.confirm(
      `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy cu·ªôc h·∫πn ${appointment.consultant_type} v√†o ng√†y ${formatDate(appointment.appointment_date)}?\n\nL∆∞u √Ω: Sau khi h·ªßy, b·∫°n s·∫Ω kh√¥ng th·ªÉ ho√†n t√°c ƒë∆∞·ª£c.`
    );
    
    if (!confirmCancel) {
      return;
    }

    try {
      setIsCancelling(true);

      const data = {
        appointment_id: appointmentId
      }

      const response = await axiosClient.post('/v1/users/cancel-appointment', data, {
        headers: { 
          'x-access-token': accessToken,
        }
      });

      if (response.data?.success) {
        // Show success message
        alert('H·ªßy cu·ªôc h·∫πn th√†nh c√¥ng!');
        
        // Update the appointment status locally
        setAppointments(prevAppointments => 
          prevAppointments.map(apt => 
            (apt.appointment_id === appointmentId || apt.id === appointmentId)
              ? { ...apt, status: 'rejected' }
              : apt
          )
        );
        
        // Refresh appointments from server
        await fetchAppointments();
        
      } else {
        throw new Error(response.data?.message || 'Kh√¥ng th·ªÉ h·ªßy cu·ªôc h·∫πn');
      }
    } catch (error) {
      console.error('‚ùå Error cancelling appointment:', error);
      
      // Show specific error messages
      if (error.response?.status === 400) {
        alert('Kh√¥ng th·ªÉ h·ªßy cu·ªôc h·∫πn n√†y. Vui l√≤ng ki·ªÉm tra tr·∫°ng th√°i cu·ªôc h·∫πn.');
      } else if (error.response?.status === 404) {
        alert('Kh√¥ng t√¨m th·∫•y cu·ªôc h·∫πn ƒë·ªÉ h·ªßy.');
      } else if (error.response?.status === 403) {
        alert('B·∫°n kh√¥ng c√≥ quy·ªÅn h·ªßy cu·ªôc h·∫πn n√†y.');
      } else {
        alert(error.response?.data?.message || 'C√≥ l·ªói x·∫£y ra khi h·ªßy cu·ªôc h·∫πn. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    } finally {
      setIsCancelling(false);
    }
  };

  if (isLoading) {
    return (
      <div className={cx('appointments-page')}>
        <div className={cx('loading-container')}>
          <FontAwesomeIcon icon={faSpinner} spin className={cx('loading-icon')} />
          <p>ƒêang t·∫£i danh s√°ch cu·ªôc h·∫πn...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className={cx('appointments-page')}>
        <div className={cx('error-container')}>
          <FontAwesomeIcon icon={faExclamationTriangle} className={cx('error-icon')} />
          <h3>C√≥ l·ªói x·∫£y ra</h3>
          <p>{error}</p>
          <button className={cx('retry-btn')} onClick={fetchAppointments}>
            <FontAwesomeIcon icon={faRefresh} /> Th·ª≠ l·∫°i
          </button>
        </div>
      </div>
    );
  }

  console.log('Appointments fetched:', appointments);

  const stats = [
    { label: 'T·ªïng cu·ªôc h·∫πn', value: appointments.length },
    { label: 'Ch·ªù x√°c nh·∫≠n', value: appointments.filter(apt => apt.status === 'pending').length },
    { label: 'ƒê√£ x√°c nh·∫≠n', value: appointments.filter(apt => apt.status === 'confirmed' && apt.booking === 0).length },
    { label: 'ƒê√£ ho√†n th√†nh thanh to√°n', value: appointments.filter(apt => apt.status === 'confirmed' && apt.booking === 1).length },
    { label: 'ƒê√£ ho√†n th√†nh t∆∞ v·∫•n', value: appointments.filter(apt => apt.status === 'completed').length },
    { label: 'ƒê√£ h·ªßy', value: appointments.filter(apt => apt.status === 'rejected').length }
  ];

  return (
    <div className={cx('appointments-page')}>
      {/* Header */}
      <div className={cx('page-header')}>
        <div className={cx('header-content')}>
          <h1 className={cx('page-title')}>
            <FontAwesomeIcon icon={faCalendarAlt} />
            L·ªãch h·∫πn c·ªßa t√¥i
          </h1>
          <p className={cx('page-subtitle')}>
            Qu·∫£n l√Ω v√† theo d√µi t·∫•t c·∫£ c√°c cu·ªôc h·∫πn t∆∞ v·∫•n c·ªßa b·∫°n
          </p>
        </div>

        <div className={cx('header-stats')}>
          {stats.map((stat, index) => (
            <div key={index} className={cx('stat-item')}>
              <span className={cx('stat-number')}>{stat.value}</span>
              <span className={cx('stat-label')}>{stat.label}</span>
            </div>
          ))}
        </div>
      </div>

      {/* Filters */}
      <div className={cx('filters-section')}>
        <div className={cx('filters-container')}>
          <div className={cx('search-box')}>
            <FontAwesomeIcon icon={faSearch} className={cx('search-icon')} />
            <input
              type="text"
              placeholder="T√¨m ki·∫øm theo t√™n, b√°c sƒ©, lo·∫°i t∆∞ v·∫•n..."
              value={filters.searchTerm}
              onChange={(e) => handleFilterChange('searchTerm', e.target.value)}
              className={cx('search-input')}
            />
          </div>

          <div className={cx('filter-group')}>
            <label className={cx('filter-label')}>
              <FontAwesomeIcon icon={faFilter} /> Tr·∫°ng th√°i
            </label>
            <select
              value={filters.status}
              onChange={(e) => handleFilterChange('status', e.target.value)}
              className={cx('filter-select')}
            >
              <option value="all">T·∫•t c·∫£</option>
              <option value="pending">Ch·ªù x√°c nh·∫≠n</option>
              <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
              <option value="success">ƒê√£ ho√†n th√†nh thanh to√°n</option>
              <option value="completed">ƒê√£ ho√†n th√†nh t∆∞ v·∫•n</option>
              <option value="rejected">ƒê√£ h·ªßy</option>
            </select>
          </div>

          <div className={cx('filter-group')}>
            <label className={cx('filter-label')}>
              <FontAwesomeIcon icon={faCalendarAlt} /> Th·ªùi gian
            </label>
            <select
              value={filters.dateRange}
              onChange={(e) => handleFilterChange('dateRange', e.target.value)}
              className={cx('filter-select')}
            >
              <option value="all">T·∫•t c·∫£</option>
              <option value="week">7 ng√†y qua</option>
              <option value="month">1 th√°ng qua</option>
              <option value="quarter">3 th√°ng qua</option>
            </select>
          </div>

          <div className={cx('results-count')}>
            Hi·ªÉn th·ªã {filteredAppointments.length} cu·ªôc h·∫πn
          </div>
        </div>
      </div>

      {/* Appointments Grid */}
      <div className={cx('appointments-container')}>
        {currentAppointments.length > 0 ? (
          <div className={cx('appointments-grid')}>
            {currentAppointments.map((appointment) => {
              const statusInfo = getStatusInfo(appointment.status);
              const hasFeedback = checkFeedbackStatus(appointment);
              
              const needsPayment = appointment.status === 'confirmed' &&
                appointment.booking === 0 &&
                appointment.price_apm &&
                appointment.price_apm > 0;

              const canJoinMeeting = appointment.status === 'confirmed' && 
                                   appointment.booking === 1 && 
                                   isConsultationDay(appointment.appointment_date);

              // Check if appointment can be cancelled
              const canCancel = appointment.status === 'pending' || 
                               (appointment.status === 'confirmed' && appointment.booking === 0);

              // Check if appointment is paid and can be cancelled for refund
              const canCancelPaid = appointment.status === 'confirmed' && 
                                   appointment.booking === 1 && 
                                   appointment.price_apm && 
                                   appointment.price_apm > 0;

              return (
                <div key={appointment.id} className={cx('appointment-card')}>
                  {/* Header */}
                  <div className={cx('card-header')}>
                    <div className={cx('status-badge')} style={{
                      backgroundColor: statusInfo.bgColor,
                      color: statusInfo.textColor
                    }}>
                      <FontAwesomeIcon icon={statusInfo.icon} />
                      {appointment.status === 'confirmed' && appointment.booking === 0 && 'Ch·ªù thanh to√°n'}
                      {appointment.status === 'confirmed' && appointment.booking === 1 && 'ƒê√£ ho√†n th√†nh thanh to√°n'}
                      {appointment.status === 'completed' && 'ƒê√£ ho√†n th√†nh t∆∞ v·∫•n'}
                      {appointment.status === 'rejected' && appointment.is_refunded && 'ƒê√£ h·ªßy (C√≥ ho√†n ti·ªÅn)'}
                      {appointment.status === 'rejected' && !appointment.is_refunded && 'ƒê√£ h·ªßy'}
                      {!['confirmed', 'completed', 'rejected'].includes(appointment.status) && statusInfo.label}
                    </div>

                    {needsPayment && (
                      <div className={cx('payment-indicator')}>
                        <FontAwesomeIcon icon={faCreditCard} />
                        <span>C·∫ßn thanh to√°n</span>
                      </div>
                    )}

                    {/* Feedback status indicator */}
                    {appointment.status === 'completed' && (
                      <div className={cx('feedback-indicator', { 'has-feedback': hasFeedback })}>
                        <FontAwesomeIcon icon={faStar} />
                        <span>{hasFeedback ? 'ƒê√£ ƒë√°nh gi√°' : 'Ch∆∞a ƒë√°nh gi√°'}</span>
                      </div>
                    )}
                  </div>

                  {/* Content */}
                  <div className={cx('card-content')}>
                    <div className={cx('info-section')}>
                      <h3 className={cx('patient-name')}>
                        {user.last_name} {user.first_name}
                      </h3>
                      <div className={cx('contact-info')}>
                        <span className={cx('info-item')}>
                          <FontAwesomeIcon icon={faPhone} /> {user.phone}
                        </span>
                        <span className={cx('info-item')}>
                          <FontAwesomeIcon icon={faEnvelope} /> {user.email}
                        </span>
                      </div>
                    </div>

                    <div className={cx('appointment-details')}>
                      <div className={cx('detail-item')}>
                        <FontAwesomeIcon icon={faCalendarAlt} />
                        <span><strong>Ng√†y:</strong> {formatDate(appointment.appointment_date)}</span>
                      </div>
                      <div className={cx('detail-item')}>
                        <FontAwesomeIcon icon={faClock} />
                        <span><strong>Gi·ªù:</strong> {appointment.appointment_time || 'Ch∆∞a x√°c ƒë·ªãnh'}</span>
                      </div>
                      <div className={cx('detail-item')}>
                        <FontAwesomeIcon icon={faUserMd} />
                        <span><strong>B√°c sƒ©:</strong> {appointment.doctor_name || 'Ch∆∞a ph√¢n c√¥ng'}</span>
                      </div>
                      <div className={cx('detail-item')}>
                        <FontAwesomeIcon icon={faStethoscope} />
                        <span><strong>Lo·∫°i t∆∞ v·∫•n:</strong> {appointment.consultant_type}</span>
                      </div>
                      {appointment.price_apm && (
                        <div className={cx('detail-item')}>
                          <FontAwesomeIcon icon={faMoneyBillWave} />
                          <span><strong>Ph√≠ t∆∞ v·∫•n:</strong> {formatCurrency(appointment.price_apm)}</span>
                        </div>
                      )}
                    </div>

                    {appointment.symptoms && (
                      <div className={cx('symptoms-section')}>
                        <div className={cx('symptoms-header')}>
                          <FontAwesomeIcon icon={faNotesMedical} />
                          <span>Tri·ªáu ch·ª©ng:</span>
                        </div>
                        <p className={cx('symptoms-text')}>{appointment.symptoms}</p>
                      </div>
                    )}
                  </div>

                  {/* Actions */}
                  <div className={cx('card-actions')}>
                    {/* Payment button */}
                    {needsPayment && (
                      <button
                        className={cx('action-btn', 'payment-btn')}
                        onClick={() => handlePayment(appointment)}
                        disabled={isCancelling}
                      >
                        <FontAwesomeIcon icon={faCreditCard} /> Thanh to√°n
                      </button>
                    )}

                    {/* Cancel button for unpaid appointments */}
                    {canCancel && (
                      <button 
                        className={cx('action-btn', 'cancel-btn', {
                          'loading': isCancelling
                        })}
                        onClick={() => handleCancel(appointment)}
                        disabled={isCancelling}
                      >
                        {isCancelling ? (
                          <>
                            <FontAwesomeIcon icon={faSpinner} spin /> ƒêang h·ªßy...
                          </>
                        ) : (
                          <>
                            <FontAwesomeIcon icon={faTrash} /> H·ªßy h·∫πn
                          </>
                        )}
                      </button>
                    )}

                    {/* Cancel with refund button for paid appointments */}
                    {canCancelPaid && (
                      <button 
                        className={cx('action-btn', 'refund-cancel-btn', {
                          'loading': isCancelling
                        })}
                        onClick={() => handleCancelPaidAppointment(appointment)}
                        disabled={isCancelling}
                        title="H·ªßy cu·ªôc h·∫πn v√† y√™u c·∫ßu ho√†n ti·ªÅn"
                      >
                        {isCancelling ? (
                          <>
                            <FontAwesomeIcon icon={faSpinner} spin /> ƒêang x·ª≠ l√Ω...
                          </>
                        ) : (
                          <>
                            <FontAwesomeIcon icon={faRefresh} /> H·ªßy & Ho√†n ti·ªÅn
                          </>
                        )}
                      </button>
                    )}

                    {/* Refund status indicator for cancelled paid appointments */}
                    {appointment.status === 'rejected' && appointment.is_refunded && (
                      <div className={cx('refund-status-indicator')}>
                        <FontAwesomeIcon icon={faRefresh} />
                        <div className={cx('refund-info')}>
                          <span className={cx('refund-label')}>‚úÖ ƒê√£ h·ªßy v√† ho√†n ti·ªÅn</span>
                          <span className={cx('refund-amount')}>
                            üí∞ S·ªë ti·ªÅn ho√†n: {formatCurrency(appointment.refund_amount)}
                          </span>
                          <span className={cx('refund-status-text')}>
                            üìã Tr·∫°ng th√°i: {appointment.refund_status === 'processing' ? 'üîÑ ƒêang x·ª≠ l√Ω' : '‚úÖ Ho√†n th√†nh'}
                          </span>
                          {appointment.refund_reference && (
                            <span className={cx('refund-reference')}>
                              üîó M√£ tham chi·∫øu: {appointment.refund_reference}
                            </span>
                          )}
                          <span className={cx('refund-note')}>
                            üìß Vui l√≤ng ki·ªÉm tra email ƒë·ªÉ theo d√µi ti·∫øn tr√¨nh ho√†n ti·ªÅn
                          </span>
                        </div>
                      </div>
                    )}

                    {/* Join Meeting button */}
                    {appointment.status === 'confirmed' && appointment.booking === 1 && (
                      <button
                        className={cx('action-btn', 'meeting-btn', { 
                          'disabled': !canJoinMeeting || isCancelling
                        })}
                        onClick={() => canJoinMeeting ? handleJoinMeeting(appointment) : null}
                        disabled={!canJoinMeeting || isCancelling}
                        title={
                          !canJoinMeeting 
                            ? 'Ch·ªâ c√≥ th·ªÉ tham gia v√†o ng√†y t∆∞ v·∫•n' 
                            : 'Tham gia cu·ªôc t∆∞ v·∫•n'
                        }
                      >
                        <FontAwesomeIcon icon={faVideo} />
                        {canJoinMeeting ? 'Tham gia t∆∞ v·∫•n' : 'Ch∆∞a t∆∞ v·∫•n ƒë∆∞·ª£c'}
                      </button>
                    )}

                    {/* Rebook button */}
                    {appointment.status === 'rejected' && (
                      <button
                        className={cx('action-btn', 'rebook-btn')}
                        onClick={handleRebook}
                        disabled={isCancelling}
                      >
                        <FontAwesomeIcon icon={faCalendarAlt} /> ƒê·∫∑t l·∫°i
                      </button>
                    )}

                    {/* Actions cho completed */}
                    {appointment.status === 'completed' && (
                      <div className={cx('completed-actions')}>
                        <div className={cx('top-actions')}>
                          <button
                            className={cx('action-btn', 'view-btn')}
                            onClick={() => viewAppointmentDetails(appointment)}
                            disabled={isCancelling}
                          >
                            <FontAwesomeIcon icon={faEye} /> Xem chi ti·∫øt
                          </button>

                          <button
                            className={cx('action-btn', 'feedback-btn', { 
                              'has-feedback': hasFeedback 
                            })}
                            onClick={() => handleFeedbackNavigation(appointment)}
                            title={hasFeedback ? 'Xem l·∫°i ƒë√°nh gi√°' : 'ƒê√°nh gi√° cu·ªôc t∆∞ v·∫•n'}
                            disabled={isCancelling}
                          >
                            <FontAwesomeIcon icon={faStar} />
                            {hasFeedback ? 'Xem ƒë√°nh gi√°' : 'ƒê√°nh gi√°'}
                          </button>
                        </div>

                        <span style={{ fontSize: '0.85rem', paddingTop: '10px'}}>
                          B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c ƒë·∫∑t l·ªãch x√©t nghi·ªám?
                        </span>
                        <Link
                          to={{
                            pathname: "/services/test",
                            search: `?appointmentId=${hashAppointmentId(
                              appointment.appointment_id || appointment.id
                            )}`,
                          }}
                          className={cx('action-btn', 'test-order-btn', 'full-width', {
                            'disabled': isCancelling
                          })}
                          onClick={isCancelling ? (e) => e.preventDefault() : undefined}
                        >
                          <FontAwesomeIcon icon={faFlaskVial} /> ƒê·∫∑t l·ªãch x√©t nghi·ªám
                        </Link>
                      </div>
                    )}

                    {/* View button cho status kh√°c */}
                    {appointment.status !== 'completed' && (
                      <button
                        className={cx('action-btn', 'view-btn')}
                        onClick={() => viewAppointmentDetails(appointment)}
                        disabled={isCancelling}
                      >
                        <FontAwesomeIcon icon={faEye} /> Xem chi ti·∫øt
                      </button>
                    )}

                    {/* Meeting info */}
                    {appointment.status === 'confirmed' && appointment.booking === 1 && !canJoinMeeting && (
                      <div className={cx('meeting-info')}>
                        <FontAwesomeIcon icon={faClock} />
                        <span>
                          C√≥ th·ªÉ tham gia t·ª´ ng√†y {formatDate(appointment.appointment_date)}
                        </span>
                      </div>
                    )}

                    {/* Cancel loading indicator */}
                    {isCancelling && (
                      <div className={cx('cancel-loading')}>
                        <FontAwesomeIcon icon={faSpinner} spin />
                        <span>ƒêang x·ª≠ l√Ω h·ªßy cu·ªôc h·∫πn...</span>
                      </div>
                    )}
                  </div>

                  <div className={cx('card-footer')}>
                    <small className={cx('created-date')}>
                      ƒê·∫∑t l·ªãch: {formatDate(appointment.created_at)}
                    </small>
                  </div>
                </div>
              );
            })}
          </div>
        ) : (
          <div className={cx('empty-state')}>
            <FontAwesomeIcon icon={faCalendarAlt} className={cx('empty-icon')} />
            <h3>Kh√¥ng c√≥ cu·ªôc h·∫πn n√†o</h3>
            <p>
              {Object.values(filters).some(f => f !== 'all' && f !== '')
                ? 'Kh√¥ng t√¨m th·∫•y cu·ªôc h·∫πn n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc c·ªßa b·∫°n.'
                : 'B·∫°n ch∆∞a c√≥ cu·ªôc h·∫πn n√†o. H√£y ƒë·∫∑t l·ªãch t∆∞ v·∫•n ngay!'
              }
            </p>
            <button
              className={cx('primary-btn')}
              onClick={() => navigate('/appointment')}
            >
              ƒê·∫∑t l·ªãch t∆∞ v·∫•n
            </button>
          </div>
        )}
      </div>

      {/* Pagination */}
      {totalPages > 1 && (
        <div className={cx('pagination')}>
          <button
            className={cx('page-btn', { disabled: currentPage === 1 })}
            onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
            disabled={currentPage === 1}
          >
            Tr∆∞·ªõc
          </button>

          {[...Array(totalPages)].map((_, index) => (
            <button
              key={index + 1}
              className={cx('page-btn', { active: currentPage === index + 1 })}
              onClick={() => setCurrentPage(index + 1)}
            >
              {index + 1}
            </button>
          ))}

          <button
            className={cx('page-btn', { disabled: currentPage === totalPages })}
            onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
            disabled={currentPage === totalPages}
          >
            Sau
          </button>
        </div>
      )}

      {/* Modal */}
      {showModal && selectedAppointment && (
        <div className={cx('modal-overlay')} onClick={() => setShowModal(false)}>
          <div className={cx('modal-content')} onClick={(e) => e.stopPropagation()}>
            <div className={cx('modal-header')}>
              <h2>Chi ti·∫øt cu·ªôc h·∫πn</h2>
              <button className={cx('close-btn')} onClick={() => setShowModal(false)}>√ó</button>
            </div>

            <div className={cx('modal-body')}>
              <div className={cx('detail-grid')}>
                <div className={cx('detail-row')}>
                  <strong>Tr·∫°ng th√°i:</strong>
                  <span className={cx('status-text')}>
                    {selectedAppointment.status === 'confirmed' && selectedAppointment.booking === 0 && 'Ch·ªù thanh to√°n'}
                    {selectedAppointment.status === 'confirmed' && selectedAppointment.booking === 1 && 'ƒê√£ ho√†n th√†nh thanh to√°n'}
                    {selectedAppointment.status === 'completed' && 'ƒê√£ ho√†n th√†nh t∆∞ v·∫•n'}
                    {selectedAppointment.status === 'pending' && 'Ch·ªù x√°c nh·∫≠n'}
                    {selectedAppointment.status === 'rejected' && selectedAppointment.is_refunded && 'ƒê√£ h·ªßy (C√≥ ho√†n ti·ªÅn)'}
                    {selectedAppointment.status === 'rejected' && !selectedAppointment.is_refunded && 'ƒê√£ h·ªßy'}
                  </span>
                </div>
                <div className={cx('detail-row')}>
                  <strong>H·ªç t√™n:</strong>
                  <span>{user.last_name} {user.first_name}</span>
                </div>
                <div className={cx('detail-row')}>
                  <strong>S·ªë ƒëi·ªán tho·∫°i:</strong>
                  <span>{user.phone}</span>
                </div>
                <div className={cx('detail-row')}>
                  <strong>Email:</strong>
                  <span>{user.email}</span>
                </div>
                <div className={cx('detail-row')}>
                  <strong>Lo·∫°i t∆∞ v·∫•n:</strong>
                  <span>{selectedAppointment.consultant_type}</span>
                </div>
                <div className={cx('detail-row')}>
                  <strong>B√°c sƒ©:</strong>
                  <span>{selectedAppointment.doctor_name || 'Ch∆∞a ph√¢n c√¥ng'}</span>
                </div>
                <div className={cx('detail-row')}>
                  <strong>Ng√†y t∆∞ v·∫•n:</strong>
                  <span>{formatDate(selectedAppointment.appointment_date)}</span>
                </div>
                <div className={cx('detail-row')}>
                  <strong>Gi·ªù t∆∞ v·∫•n:</strong>
                  <span>{selectedAppointment.appointment_time || 'Ch∆∞a x√°c ƒë·ªãnh'}</span>
                </div>
                {selectedAppointment.price_apm && (
                  <div className={cx('detail-row')}>
                    <strong>Ph√≠ t∆∞ v·∫•n:</strong>
                    <span>{formatCurrency(selectedAppointment.price_apm)}</span>
                  </div>
                )}
                <div className={cx('detail-row')}>
                  <strong>Ng√†y ƒë·∫∑t:</strong>
                  <span>{formatDate(selectedAppointment.created_at)}</span>
                </div>
                
                {/* Refund status trong modal */}
                {selectedAppointment.status === 'rejected' && selectedAppointment.is_refunded && (
                  <>
                    <div className={cx('detail-row')}>
                      <strong>Tr·∫°ng th√°i ho√†n ti·ªÅn:</strong>
                      <span className={cx('refund-status', { 
                        'processing': selectedAppointment.refund_status === 'processing'
                      })}>
                        <FontAwesomeIcon icon={faRefresh} />
                        {selectedAppointment.refund_status === 'processing' ? 'üîÑ ƒêang x·ª≠ l√Ω' : '‚úÖ Ho√†n th√†nh'}
                      </span>
                    </div>
                    {selectedAppointment.refund_amount && (
                      <div className={cx('detail-row')}>
                        <strong>S·ªë ti·ªÅn ho√†n:</strong>
                        <span className={cx('refund-amount-text')}>
                          üí∞ {formatCurrency(selectedAppointment.refund_amount)}
                        </span>
                      </div>
                    )}
                    {selectedAppointment.refund_reference && (
                      <div className={cx('detail-row')}>
                        <strong>M√£ tham chi·∫øu:</strong>
                        <span className={cx('refund-reference-text')}>
                          üîó {selectedAppointment.refund_reference}
                        </span>
                      </div>
                    )}
                    {selectedAppointment.refund_date && (
                      <div className={cx('detail-row')}>
                        <strong>Ng√†y y√™u c·∫ßu ho√†n ti·ªÅn:</strong>
                        <span>{formatDate(selectedAppointment.refund_date)}</span>
                      </div>
                    )}
                  </>
                )}

                {/* Feedback status trong modal */}
                {selectedAppointment.status === 'completed' && (
                  <div className={cx('detail-row')}>
                    <strong>Tr·∫°ng th√°i ƒë√°nh gi√°:</strong>
                    <span className={cx('feedback-status', { 
                      'has-feedback': checkFeedbackStatus(selectedAppointment)
                    })}>
                      <FontAwesomeIcon icon={faStar} />
                      {checkFeedbackStatus(selectedAppointment) ? 'ƒê√£ ƒë√°nh gi√°' : 'Ch∆∞a ƒë√°nh gi√°'}
                    </span>
                  </div>
                )}
              </div>

              {selectedAppointment.symptoms && (
                <div className={cx('medical-info')}>
                  <h3>Th√¥ng tin y t·∫ø</h3>
                  <div className={cx('medical-item')}>
                    <strong>Tri·ªáu ch·ª©ng:</strong>
                    <p>{selectedAppointment.symptoms}</p>
                  </div>
                </div>
              )}
            </div>

            {/* Modal Actions */}
            {selectedAppointment.status === 'completed' && (
              <div className={cx('modal-actions')}>
                <h3>H√†nh ƒë·ªông kh·∫£ d·ª•ng</h3>
                <div className={cx('action-buttons-horizontal')}>
                  {/* Updated feedback button trong modal */}
                  <button
                    className={cx('modal-action-btn', 'feedback-btn', {
                      'has-feedback': checkFeedbackStatus(selectedAppointment)
                    })}
                    onClick={() => {
                      setShowModal(false);
                      handleFeedbackNavigation(selectedAppointment);
                    }}
                  >
                    <FontAwesomeIcon icon={faStar} />
                    {checkFeedbackStatus(selectedAppointment) ? 'Xem ƒë√°nh gi√°' : 'ƒê√°nh gi√° cu·ªôc t∆∞ v·∫•n'}
                  </button>

                  <Link
                    to={{
                      pathname: "/services/test",
                      search: `?appointmentId=${hashAppointmentId(
                        selectedAppointment.appointment_id || selectedAppointment.id
                      )}`,
                    }}
                    className={cx('modal-action-btn', 'test-order-btn')}
                    onClick={() => setShowModal(false)}
                  >
                    <FontAwesomeIcon icon={faFlaskVial} /> ƒê·∫∑t l·ªãch x√©t nghi·ªám
                  </Link>
                </div>

                <div className={cx('action-note')}>
                  <p>
                    üí° <strong>G·ª£i √Ω:</strong> 
                    {checkFeedbackStatus(selectedAppointment) 
                      ? ' C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°! B·∫°n c√≥ th·ªÉ ƒë·∫∑t l·ªãch x√©t nghi·ªám ƒë·ªÉ theo d√µi s·ª©c kh·ªèe theo ch·ªâ ƒë·ªãnh c·ªßa b√°c sƒ©.'
                      : ' Sau khi t∆∞ v·∫•n, h√£y chia s·∫ª ƒë√°nh gi√° c·ªßa b·∫°n v√† c√≥ th·ªÉ ƒë·∫∑t l·ªãch x√©t nghi·ªám theo ch·ªâ ƒë·ªãnh c·ªßa b√°c sƒ©.'
                    }
                  </p>
                </div>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

export default MyAppointments;